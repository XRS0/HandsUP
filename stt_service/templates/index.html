<!DOCTYPE html>
<html>

<head>
	<title>Speech to Text</title>
	<style>
		#output {
			font-family: sans-serif;
			font-size: 1.2em;
			margin-top: 1em;
		}

		.final {
			color: black;
		}

		.partial {
			color: gray;
		}
	</style>
</head>

<body>
	<h1>Speech Recognition</h1>
	<button id="start">Start</button>
	<div id="output"></div>

	<script>
		const output = document.getElementById('output');
		const startBtn = document.getElementById('start');

		let partialSpan = null;

		startBtn.onclick = async () => {
			const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
			const audioContext = new AudioContext({ sampleRate: 16000 });

			await audioContext.audioWorklet.addModule('audio-processor.js');

			const socket = new WebSocket('ws://localhost:8000');
			socket.binaryType = 'arraybuffer';

			const source = audioContext.createMediaStreamSource(stream);
			const processorNode = new AudioWorkletNode(audioContext, 'audio-processor');

			processorNode.port.onmessage = (event) => {
				if (socket.readyState === WebSocket.OPEN) {
					socket.send(event.data);
				}
			};

			socket.onmessage = (event) => {
				const message = event.data.trim();
				if (!message) return;

				// Если короткий текст, считаем его partial
				if (message.endsWith('.')) {
					// Это финальный результат
					const finalDiv = document.createElement('div');
					finalDiv.className = 'final';
					finalDiv.textContent = message;
					output.appendChild(finalDiv);
					// Очистить partial
					if (partialSpan) {
						partialSpan.remove();
						partialSpan = null;
					}
				} else {
					// Это partial результат
					if (!partialSpan) {
						partialSpan = document.createElement('div');
						partialSpan.className = 'partial';
						output.appendChild(partialSpan);
					}
					partialSpan.textContent = message;
				}
				output.scrollTop = output.scrollHeight; // прокрутка вниз
			};

			source.connect(processorNode).connect(audioContext.destination);
		};
	</script>


</body>

</html>